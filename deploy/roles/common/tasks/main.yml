---
- name: Ensure apt keys are present
  apt_key:
    url: "{{ item }}"
    state: present
  with_items:
    - https://www.postgresql.org/media/keys/ACCC4CF8.asc
    - http://nginx.org/keys/nginx_signing.key
  become: yes

- name: Ensure apt repositories are present
  apt_repository:
    repo: "{{ item }}"
    state: present
  with_items:
    - deb http://apt.postgresql.org/pub/repos/apt/ xenial-pgdg main
    - deb http://nginx.org/packages/ubuntu/ xenial nginx
  become: yes

- name: Update apt cache
  apt: update_cache=true
  become: yes

- name: Ensure required packages are installed
  apt:
    pkg: "{{ item }}"
    state: installed
  with_items:
    - postgresql-9.6
    - nginx
    - python-psycopg2
    - python-passlib
  become: yes

- name: Ensure freshcomics group is present
  group:
    name: "{{ freshcomics_group }}"
    state: present
  become: yes

- name: Ensure freshcomics user is present
  user:
    name: "{{ freshcomics_user }}"
    group: "{{ freshcomics_group }}"
    state: present
    home: "{{ freshcomics_home }}"
  become: yes

- name: Ensure freshcomicsdb is present
  postgresql_db:
    name: "{{ freshcomics_dbname }}"
    encoding: UTF-8
  become: yes
  become_user: postgres

- name: Ensure freshcomics DB user is present
  postgresql_user:
    db: "{{ freshcomics_dbname }}"
    name: "{{ freshcomics_user }}"
    password: "{{ freshcomics_dbpassword }}"
    state: present
    priv: ALL
  become: yes
  become_user: postgres

- name: Ensure database backups directory is present
  file:
    path: "/opt/freshcomics/backup"
    state: directory
    owner: postgres
    group: "{{ freshcomics_group }}"
  become: yes

- name: Setup backups of freshcomicsdb
  cron:
    name: "{{ item.name }}"
    user: postgres
    minute: 0
    hour: 0
    job: "{{ item.job }}"
    state: present
  become: yes
  with_items:
    - name: "backup {{ freshcomics_dbname }}"
      job: "pg_dump {{ freshcomics_dbname }} | gzip - > {{ freshcomics_home}}/backup/{{ freshcomics_dbname }}_$(date +%Y%m%d%H%M%S).pg.gz"
    - name: "prune old {{ freshcomics_dbname }} backups"
      job: "find {{ freshcomics_home }}/backup/{{ freshcomics_dbname }}_*.pg.gz -mtime +7 -delete"

- name: Ensure default nginx.conf is absent
  file:
    path: /etc/nginx/conf.d/default.conf
    state: absent
  become: yes

...